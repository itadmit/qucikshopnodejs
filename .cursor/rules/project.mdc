---
description: ×—×•×§×™ ×¤×™×ª×•×— - QuickShop SaaS
globs:
alwaysApply: true
---
# ×—×•×§×™ ×¤×™×ª×•×— - QuickShop SaaS

## ×¢×§×¨×•× ×•×ª ×™×¡×•×“

### 1. SaaS Architecture
- **×ª××™×“ ×’× ×¨×™**: ××£ ×¤×¢× ×œ× ×œ×›×ª×•×‘ ×§×•×“ ×¡×¤×¦×™×¤×™ ×œ×—× ×•×ª ××• ××©×ª××© ××¡×•×™×
- **Multi-tenant**: ×›×œ ×¤×™×¦'×¨ ×—×™×™×‘ ×œ×ª××•×š ×‘××¡×¤×¨ ×—× ×•×™×•×ª ×•××©×ª××©×™×
- **Store Context**: ×ª××™×“ ×œ×–×”×•×ª ××ª ×”×—× ×•×ª ×”× ×•×›×—×™×ª ××”×“×•××™×™×Ÿ ××• ××”×¤×¨××˜×¨×™×

### 2. Port Configuration
```
Backend:  localhost:3001
Frontend: localhost:5173 (Vite default)
```

### 3. Domain Structure
```
Development:
- Main App: localhost:5173
- Store: {store-slug}.localhost:5173
- API: localhost:3001/api

Production:
- Main App: my-quickshop.com
- Store: {store-slug}.my-quickshop.com  
- API: api.my-quickshop.com (NO /api prefix)
```

## Authentication Rules

### 1. Always Use Unified Auth
```javascript
// âœ… × ×›×•×Ÿ - ×”×©×ª××© ×‘-middleware ×”×××•×—×“
import { requireDashboardAccess, requireAuth, requireStoreAccess } from '../middleware/unified-auth.js';

// âŒ ×œ× × ×›×•×Ÿ - ×œ× ×œ×”×©×ª××© ×‘-middleware ×™×©×Ÿ
import { authenticateToken } from '../middleware/auth.js'; // DELETED
```

### 2. Middleware Types
```javascript
// ××™××•×ª ×‘×¡×™×¡×™ (×¨×§ ×‘×“×™×§×ª ××©×ª××©)
router.get('/profile', requireAuth, handler);

// ×“×©×‘×•×¨×“ (××™××•×ª + ×× ×•×™ + ×–×™×”×•×™ ×—× ×•×ª)
router.get('/stats', requireDashboardAccess, handler);

// ×—× ×•×ª (××™××•×ª + ×–×™×”×•×™ ×—× ×•×ª)
router.get('/products', requireStoreAccess, handler);

// ×¤×¨×™××™×•× (××™××•×ª + ×× ×•×™ + ×‘×“×™×§×ª ×ª×•×›× ×™×ª)
router.get('/advanced-analytics', requirePremium, handler);
```

### 3. Access Current Store
```javascript
// âœ… × ×›×•×Ÿ - ×’×™×©×” ×œ×—× ×•×ª ×”× ×•×›×—×™×ª
router.get('/products', requireStoreAccess, async (req, res) => {
  const store = req.currentStore; // ×–×™×”×•×™ ××•×˜×•××˜×™
  const storeId = req.storeId;
  
  const products = await prisma.product.findMany({
    where: { storeId: store.id }
  });
});

// âŒ ×œ× × ×›×•×Ÿ - ×”×¨×“×§×•×“ ×©×œ ×—× ×•×ª ×¡×¤×¦×™×¤×™×ª
const products = await prisma.product.findMany({
  where: { storeId: 1 } // NEVER!
});
```

## API Routes Structure

### 1. Generic Routes
```javascript
// âœ… × ×›×•×Ÿ - × ×ª×™×‘×™× ×’× ×¨×™×™×
/api/products          // ×›×œ ×”××•×¦×¨×™× ×©×œ ×”×—× ×•×ª ×”× ×•×›×—×™×ª
/api/orders           // ×›×œ ×”×”×–×× ×•×ª ×©×œ ×”×—× ×•×ª ×”× ×•×›×—×™×ª
/api/customers        // ×›×œ ×”×œ×§×•×—×•×ª ×©×œ ×”×—× ×•×ª ×”× ×•×›×—×™×ª

// âŒ ×œ× × ×›×•×Ÿ - × ×ª×™×‘×™× ×¡×¤×¦×™×¤×™×™×
/api/stores/123/products  // NEVER!
/api/yogevstore/orders    // NEVER!
```

### 2. Store Identification
```javascript
// ×”×–×™×”×•×™ × ×¢×©×” ××•×˜×•××˜×™ ×‘-middleware:
// 1. ××”×“×•××™×™×Ÿ: yogevstore.localhost:5173 â†’ storeSlug = "yogevstore"
// 2. ××¤×¨××˜×¨×™×: ?storeSlug=yogevstore
// 3. ××”-body: { storeSlug: "yogevstore" }
// 4. ×‘×¨×™×¨×ª ××—×“×œ: ×”×—× ×•×ª ×”×¨××©×•× ×” ×”×¤×¢×™×œ×” ×©×œ ×”××©×ª××©
```

## Environment Configuration

### 1. Frontend Environment
```javascript
// âœ… × ×›×•×Ÿ - ×©×™××•×© ×‘×¤×•× ×§×¦×™×•×ª ×¢×–×¨
import { getApiUrl, isStoreSubdomain, getStoreSlugFromDomain } from '../config/environment.js';

const apiUrl = getApiUrl('/products'); // ××•×˜×•××˜×™ ×œ×¤×™ ×¡×‘×™×‘×”
const isStore = isStoreSubdomain(); // ×‘×“×™×§×” ×× ×–×” ×—× ×•×ª
const storeSlug = getStoreSlugFromDomain(); // ×§×‘×œ×ª ×©× ×”×—× ×•×ª

// âŒ ×œ× × ×›×•×Ÿ - ×”×¨×“×§×•×“ ×©×œ URLs
const apiUrl = 'http://localhost:3001/api/products'; // NEVER!
```

### 2. Environment Files
```bash
# Development
frontend/.env.development:
VITE_API_URL=/api
VITE_NODE_ENV=development

# Production  
frontend/.env.production:
VITE_API_URL=https://api.my-quickshop.com
VITE_NODE_ENV=production
```

## Database Queries

### 1. Always Filter by Store
```javascript
// âœ… × ×›×•×Ÿ - ×ª××™×“ ×œ×¡× ×Ÿ ×œ×¤×™ ×—× ×•×ª
const products = await prisma.product.findMany({
  where: { 
    storeId: req.currentStore.id,
    status: 'PUBLISHED'
  }
});

// âŒ ×œ× × ×›×•×Ÿ - ×©××™×œ×ª×” ×’×œ×•×‘×œ×™×ª
const products = await prisma.product.findMany(); // NEVER!
```

### 2. User's Stores Only
```javascript
// âœ… × ×›×•×Ÿ - ×¨×§ ×—× ×•×™×•×ª ×©×œ ×”××©×ª××©
const stores = await prisma.store.findMany({
  where: { 
    userId: req.authenticatedUser.id,
    isActive: true
  }
});

// âŒ ×œ× × ×›×•×Ÿ - ×›×œ ×”×—× ×•×™×•×ª
const stores = await prisma.store.findMany(); // NEVER!
```

## Error Handling

### 1. Consistent Error Format
```javascript
// âœ… × ×›×•×Ÿ - ×¤×•×¨××˜ ×©×’×™××” ××—×™×“
return res.status(404).json({
  error: 'Not found',
  message: '×”××•×¦×¨ ×œ× × ××¦×'
});

// âŒ ×œ× × ×›×•×Ÿ - ×¤×•×¨××˜×™× ×©×•× ×™×
return res.status(404).send('Not found'); // NEVER!
```

### 2. Hebrew Messages for Users
```javascript
// âœ… × ×›×•×Ÿ - ×”×•×“×¢×•×ª ×‘×¢×‘×¨×™×ª ×œ××©×ª××©
message: '×œ× × ××¦××” ×—× ×•×ª ×¤×¢×™×œ×” ×¢×‘×•×¨ ×”××©×ª××©'

// âœ… × ×›×•×Ÿ - ×”×•×“×¢×•×ª ×‘×× ×’×œ×™×ª ×œ×“×‘××’
console.error('Store identification error:', error.message);
```

## File Organization

### 1. Clean Architecture
```
backend/
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ unified-auth.js     âœ… ××™××•×ª ×××•×—×“
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ dashboard.js        âœ… ×’× ×¨×™ ×œ×›×œ ×—× ×•×ª
â”‚   â”œâ”€â”€ products.js         âœ… ×’× ×¨×™ ×œ×›×œ ×—× ×•×ª
â”‚   â””â”€â”€ stores.js           âœ… × ×™×”×•×œ ×—× ×•×™×•×ª
â””â”€â”€ models/
    â””â”€â”€ Store.js            âœ… ××•×“×œ ×’× ×¨×™
```

### 2. Remove Old Files
```bash
# ×§×‘×¦×™× ×œ××—×™×§×”:
middleware/auth.js          âŒ ×™×©×Ÿ - × ××—×§
*.backup                    âŒ ×’×™×‘×•×™×™×
*.old                       âŒ ×§×‘×¦×™× ×™×©× ×™×
*.tmp                       âŒ ×§×‘×¦×™× ×–×× ×™×™×
```

## Development Workflow

### 1. Starting Development
```bash
# Backend
cd backend && npm start

# Frontend (new terminal)
cd frontend && npm run dev

# Access:
# Main app: http://localhost:5173
# Store: http://yogevstore.localhost:5173
```

### 2. Testing Multi-Store
```bash
# Add to /etc/hosts (if needed):
127.0.0.1 yogevstore.localhost
127.0.0.1 teststore.localhost

# Or use direct URLs:
http://yogevstore.localhost:5173
http://teststore.localhost:5173
```

## Deployment Rules

### 1. Frontend Build
```bash
# Build for production
npm run build

# Deploy to S3
aws s3 sync dist/ s3://my-quickshop-frontend/
```

### 2. Backend Deploy
```bash
# Deploy only backend folder to EC2
scp -r backend/ user@ec2:/var/www/quickshop/

# No /api prefix in production routes
# API runs on api.my-quickshop.com directly
```

## Code Review Checklist

### âœ… Before Committing
- [ ] No hardcoded store IDs or user IDs
- [ ] Uses unified auth middleware
- [ ] Filters queries by current store
- [ ] Hebrew error messages for users
- [ ] English debug messages
- [ ] No old middleware imports
- [ ] Environment-aware URLs
- [ ] Generic route patterns

### âŒ Red Flags
- Hardcoded IDs: `storeId: 1`
- Global queries: `findMany()` without `where`
- Old auth: `import from '../middleware/auth.js'`
- Hardcoded URLs: `'http://localhost:3001'`
- English user messages
- Store-specific logic

## Common Patterns

### 1. New Route Template
```javascript
import express from 'express';
import { requireStoreAccess } from '../middleware/unified-auth.js';
import { PrismaClient } from '@prisma/client';

const router = express.Router();
const prisma = new PrismaClient();

router.get('/', requireStoreAccess, async (req, res) => {
  try {
    const store = req.currentStore;
    
    const data = await prisma.model.findMany({
      where: { storeId: store.id }
    });
    
    res.json(data);
  } catch (error) {
    console.error('API error:', error.message);
    res.status(500).json({
      error: 'Internal server error',
      message: '×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×'
    });
  }
});

export default router;
```

### 2. Frontend API Call
```javascript
import { getApiUrl } from '../config/environment.js';

const fetchData = async () => {
  try {
    const response = await fetch(getApiUrl('/products'), {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error('Failed to fetch');
    }
    
    return await response.json();
  } catch (error) {
    console.error('Fetch error:', error);
    throw error;
  }
};
```

---

**×–×›×•×¨**: QuickShop ×”×•× SaaS - ×ª××™×“ ×—×©×•×‘ ×’× ×¨×™, ×ª××™×“ ×ª××•×š ×‘××¡×¤×¨ ×—× ×•×™×•×ª, ×ª××™×“ ×”×©×ª××© ×‘××¢×¨×›×ª ×”××™××•×ª ×”×××•×—×“×ª!

# ×¡×˜×˜×•×¡ ××¡×“ × ×ª×•× ×™×
./db-commands.sh status

# ××™×¤×•×¡ ××¡×“ × ×ª×•× ×™×
./db-commands.sh reset

# ×¤×ª×™×—×ª Prisma Studio
./db-commands.sh studio

# ×’×™×‘×•×™ ××§×•××™
./db-commands.sh backup


ğŸ“Š × ×ª×•× ×™ ×”×“××•:
Email: demo@quickshop.co.il
Password: demo123
×—× ×•×ª: "×”×—× ×•×ª ×©×œ×™" ×¢× slug my-store

#×¢×¦×™×¨×ª ×©×¨×ª×™×
./stop-dev.sh
#×¤×ª×™×—×ª ×©×¨×ª×™× ×œ×¡×‘×™×‘×ª ×¤×™×ª×•×—
 ./start-dev.sh


# ×¤×¨×™×¡×” ××œ××”
./deploy-full.sh full

# ××• ×©×œ×‘ ××—×¨ ×©×œ×‘
./deploy-full.sh database   # migrations ×“×¨×š EC2
./deploy-full.sh backend    # ×¢×“×›×•×Ÿ ×§×•×“ ×‘×©×¨×ª
./deploy-full.sh frontend   # build ×•-upload ×œ-S3


×¢×•×“ ×¤×¨×˜×™× ×‘:
README.md